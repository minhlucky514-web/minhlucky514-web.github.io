<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spin Wheel + Flipbook PDF</title>

<!-- VIDEO BACKGROUND -->
<style>
.video-bg {
    position: fixed;
    top:0; left:0;
    width:100%; height:100%;
    overflow:hidden;
    z-index:-1;
}
.video-bg video {
    width:100%; height:100%;
    object-fit:cover;
}

/* BODY & LAYOUT */
body{
    margin:0;
    font-family:Arial,sans-serif;
    color:#eee;
    display:flex;
    flex-direction:column;
    align-items:center;
    min-height:100vh;
    background:transparent;
}

/* ITEMS TEXTAREA */
#itemsArea{
    width:300px;
    max-width:90vw;
    height:120px;
    margin:10px 0;
    padding:8px;
    font-family:monospace;
    background:rgba(0,0,0,0.5);
    color:#fff;
    border:none;
    border-radius:8px;
}

/* MAIN ROW */
#mainRow{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:20px;
    flex-wrap:wrap;
}
.side-img{
    width:80px;
    height:auto;
    object-fit:contain;
}

/* WHEEL */
#wheelContainer{
    position:relative;
    width:80vw;
    max-width:500px;
    aspect-ratio:1/1;
}
canvas{
    position:absolute;
    top:0; left:0;
    width:100%;
    height:100%;
}
button#spinCenter{
    position:absolute;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    width:15%;
    min-width:70px;
    aspect-ratio:1/1;
    border-radius:50%;
    border:none;
    font-size:1em;
    font-weight:bold;
    cursor:pointer;
}

/* PDF BUTTON */
#pdfButtons{
    margin:15px 0;
    display:flex;
    gap:15px;
    flex-wrap:wrap;
}
.pdfBtn{
    padding:10px 15px;
    font-size:16px;
    font-weight:bold;
    border:none;
    border-radius:8px;
    cursor:pointer;
    transition:background 0.3s,color 0.3s,transform 0.2s;
}

/* RESULT */
#result{
    margin-top:15px;
    font-size:1.2em;
    font-weight:bold;
}

/* PDF FLIPBOOK MODAL */
#pdfModal{
    display:none;
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    background:rgba(0,0,0,0.8);
    justify-content:center;
    align-items:center;
    z-index:10;
    flex-direction:column;
}
#pdfModal.active{display:flex;}
#flipbookContainer{
    width:80%;
    max-width:800px;
    height:80%;
}
#closePdf{
    margin-top:10px;
    padding:5px 10px;
    font-size:1em;
}
</style>
</head>
<body>

<!-- VIDEO BACKGROUND -->
<div class="video-bg">
    <video autoplay muted loop playsinline>
        <source src="./assets/videos/sakura.mp4" type="video/mp4">
    </video>
</div>

<!-- ITEMS -->
<textarea id="itemsArea">Hưng
Kiệt
Khoa
Dũng
Matsumoto
Doanh
Hoa
Giang
Công
Cường
Thiện
Shiraki</textarea>

<!-- WHEEL -->
<div id="mainRow">
    <img src="./assets/images/ojigi.webp" class="side-img">
    <div id="wheelContainer">
        <canvas id="wheelCanvas"></canvas>
        <canvas id="fireCanvas"></canvas>
        <button id="spinCenter">SPIN</button>
    </div>
    <img src="./assets/images/ojigi.webp" class="side-img">
</div>
<div id="result"></div>

<!-- PDF BUTTON -->
<div id="pdfButtons">
    <button class="pdfBtn" data-path="./assets/pdfs/250101_朝礼の流れ（スピーチ番号資料付）.pdf">PDF Flipbook</button>
</div>

<!-- PDF FLIPBOOK MODAL -->
<div id="pdfModal">
    <div id="flipbookContainer"></div>
    <button id="closePdf">Close</button>
</div>

<!-- LIBRARIES -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.14.2/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/st-pageflip/dist/js/page-flip.browser.min.js"></script>

<script>
// === WHEEL LOGIC ===
const wheel = document.getElementById('wheelCanvas');
const ctx = wheel.getContext('2d');
const itemsArea = document.getElementById('itemsArea');
const spinCenter = document.getElementById('spinCenter');
const resultDiv = document.getElementById('result');
let items=[], rotation=0, spinning=false, hueOffset=0;

function parseText(t){ return t.split(/\r?\n/).map(l=>l.trim()).filter(Boolean); }
function drawWheel(){
    const w=wheel.width=wheel.offsetWidth;
    const h=wheel.height=wheel.offsetHeight;
    const r=Math.min(w,h)/2-10;
    ctx.clearRect(0,0,w,h);
    ctx.save(); ctx.translate(w/2,h/2); ctx.rotate(rotation);
    const slice=2*Math.PI/(items.length||1);
    for(let i=0;i<(items.length||1);i++){
        ctx.beginPath(); ctx.moveTo(0,0); ctx.arc(0,0,r,i*slice,(i+1)*slice);
        const hue=(i*40+hueOffset)%360;
        ctx.fillStyle=`hsl(${hue},70%,55%)`; ctx.fill();
        ctx.save(); ctx.rotate(i*slice+slice/2);
        ctx.fillStyle='#fff'; ctx.font='16px sans-serif'; ctx.textAlign='right';
        ctx.fillText(items[i]||'',r-10,5);
        ctx.restore();
    }
    ctx.restore();
}

function spin(){
    if(spinning || items.length===0) return;
    spinning=true;
    const slice=2*Math.PI/items.length;
    const target=Math.floor(Math.random()*items.length);
    const finalAngle=(2*Math.PI-(target*slice+slice/2))%(2*Math.PI);
    const extra=6*2*Math.PI;
    const start=rotation;
    const diff=finalAngle-start+extra;
    const st=performance.now();
    function animate(t){
        const p=Math.min(1,(t-st)/3000);
        const ease=1-Math.pow(1-p,3);
        rotation=start+diff*ease; drawWheel();
        if(p<1) requestAnimationFrame(animate);
        else { resultDiv.textContent=`Kết quả: ${items[target]}`; spinning=false; }
    }
    requestAnimationFrame(animate);
}

function update(){ items=parseText(itemsArea.value); drawWheel(); }
update();
itemsArea.addEventListener('input',update);
spinCenter.addEventListener('click',spin);

function animateHue(){
    hueOffset+=1; if(hueOffset>360) hueOffset=0; drawWheel();
    const btnHue=(hueOffset+30)%360;
    spinCenter.style.background=`hsl(${btnHue},70%,55%)`;
    spinCenter.style.color=`hsl(${(btnHue+180)%360},80%,95%)`;
    document.querySelectorAll('.pdfBtn').forEach(btn=>{
        btn.style.background=`hsl(${btnHue},70%,55%)`;
        btn.style.color=`hsl(${(btnHue+180)%360},80%,95%)`;
    });
    requestAnimationFrame(animateHue);
}
animateHue();

// === PDF FLIPBOOK LOGIC ===
const pdfModal=document.getElementById('pdfModal');
const flipbookContainer=document.getElementById('flipbookContainer');
let pageFlip=null;

document.querySelectorAll('.pdfBtn').forEach(btn=>{
    btn.addEventListener('click',()=>{
        const url=btn.getAttribute('data-path');
        pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.14.2/pdf.worker.min.js';
        pdfjsLib.getDocument(url).promise.then(doc=>{
            const pages=[];
            const renderPage=(num)=>doc.getPage(num).then(page=>{
                const viewport=page.getViewport({scale:1.5});
                const canvas=document.createElement('canvas');
                canvas.width=viewport.width; canvas.height=viewport.height;
                const ctxc=canvas.getContext('2d');
                page.render({canvasContext:ctxc,viewport:viewport});
                pages.push(canvas);
            });
            const tasks=[];
            for(let i=1;i<=doc.numPages;i++) tasks.push(renderPage(i));
            Promise.all(tasks).then(()=>{
                flipbookContainer.innerHTML=''; pages.forEach(p=>flipbookContainer.appendChild(p));
                if(pageFlip) pageFlip.destroy();
                pageFlip=new St.PageFlip.PageFlip(flipbookContainer, {width:400,height:500, maxShadowOpacity:0.5});
                pageFlip.loadFromHTML(document.querySelectorAll('#flipbookContainer > canvas'));
                pdfModal.classList.add('active');
            });
        });
    });
});
document.getElementById('closePdf').addEventListener('click',()=>{pdfModal.classList.remove('active');});
</script>

</body>
</html>